/*
 * Copyright (c) 2025-2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

 /*---
    tags: [no-warmup]
 ---*/

function testInit() {
    let str = 'workerLocal';
    let wl = new WorkerLocal<string>(() => str);
    arktest.assertEQ(wl.get(), str);
    wl.set('main');
    arktest.assertEQ(wl.get(), 'main');
    await taskpool.execute(() => {
        arktest.assertEQ(wl.get(), str);
        wl.set('subWorker');
        arktest.assertEQ(wl.get(), 'subWorker');
        wl.delete();
        arktest.assertEQ(wl.get(), str);
    })
    arktest.assertEQ(wl.get(), 'main');
}

async function testWithoutInit() {
    let wl = new WorkerLocal<int>();
    arktest.expectError(() => {
        wl.get();
    }, new Error('WorkerLocal:: Value not initialized. Call set() first or provide an init function'))
    wl.set(1);
    arktest.assertEQ(wl.get(), 1);
    wl.set(wl.get() + 1);
    arktest.assertEQ(wl.get(), 2);
    await taskpool.execute(() => {
        arktest.expectError(() => {
            wl.get();
        }, new Error('WorkerLocal:: Value not initialized. Call set() first or provide an init function'))
        wl.set(1);
        arktest.assertEQ(wl.get(), 1);
        wl.set(wl.get() + 1);
        arktest.assertEQ(wl.get(), 2);
        wl.delete()
        arktest.expectError(() => {
            wl.get();
        }, new Error('WorkerLocal:: Value not initialized. Call set() first or provide an init function'))
    })
    arktest.assertEQ(wl.get(), 2);
}

class TestObject{
     constructor(){
     }

     constructor(a1:string,a2:int){
         this.a1= a1;
         this.a2=a2;
     }

     a1 = 'a1';
     a2 = 0;
}

function testWithMultiInit() {
    let wl = new WorkerLocal<TestObject>(() => new TestObject('a0', 0));
    arktest.assertEQ(wl.get().a1, 'a0');
    arktest.assertEQ(wl.get().a2, 0);
    for(let i = 0; i < 50; i++){
        arktest.assertEQ(wl.get().a1, 'a0');
        arktest.assertEQ(wl.get().a2, 0);
        for(let i = 0; i < 20; i++){
            wl.set(new TestObject('a' + i, i));
            arktest.assertEQ(wl.get().a1, 'a' + i);
            arktest.assertEQ(wl.get().a2, i);
            wl.delete();
        }
        arktest.assertEQ(wl.get().a1, 'a0');
        arktest.assertEQ(wl.get().a2, 0);
    }
}

function testWithworkerInit(){
    let initCount = 0;
    let wl =new WorkerLocal<TestObject>(() =>{
        initCount++;
        return new TestObject('a0', initCount);
    });
    let eaw = new EAWorker();
    eaw.start();
    let job = eaw.run<void>(()=>{
        let v1 = wl.get();
        arktest.assertEQ(v1.a1, 'a0');
        let v2 = wl.get();
        arktest.assertEQ(v2, v1);
    });
    job.Await();
    arktest.assertEQ(initCount, 1);
    eaw.quit();
}

async function testConcurrentReads() {
    let wl = new WorkerLocal<int>(() => 100);
    let workerCount = 50;
    let iterationsPerWorker = 10;

    let promises = new Array<Promise<Any>>(workerCount);
    for(let i = 0; i < workerCount; i++) {
        promises.push(taskpool.execute(() => {
            for(let j = 0; j < iterationsPerWorker; j++) {
                let value = wl.get();
                arktest.assertEQ(value, 100);
            }
        }));
    }

    await Promise.all(promises);
}

async function testConcurrentWrites() {
    let wl = new WorkerLocal<int>(() => 0);
    let workerCount = 20;
    let iterationsPerWorker = 5;

    let promises = new Array<Promise<Any>>(workerCount);
    for(let i = 0; i < workerCount; i++) {
        let workerId = i;
        promises.push(taskpool.execute(() => {
            for(let j = 0; j < iterationsPerWorker; j++) {
                wl.set(workerId * 100 + j);
                let value = wl.get();
                arktest.assertEQ(value, workerId * 100 + j);
            }
        }));
    }

    await Promise.all(promises);

    arktest.assertEQ(wl.get(), 0);
}

async function testMultipleInstances() {
    let wl1 = new WorkerLocal<int>(() => 1);
    let wl2 = new WorkerLocal<string>(() => 'default');
    let wl3 = new WorkerLocal<TestObject>(() => new TestObject('obj', 0));

    arktest.assertEQ(wl1.get(), 1);
    arktest.assertEQ(wl2.get(), 'default');
    arktest.assertEQ(wl3.get().a1, 'obj');

    wl1.set(100);
    wl2.set('modified');
    wl3.set(new TestObject('new', 99));

    arktest.assertEQ(wl1.get(), 100);
    arktest.assertEQ(wl2.get(), 'modified');
    arktest.assertEQ(wl3.get().a2, 99);

    await taskpool.execute(() => {
        arktest.assertEQ(wl1.get(), 1);
        arktest.assertEQ(wl2.get(), 'default');
        arktest.assertEQ(wl3.get().a1, 'obj');

        wl1.set(200);
        wl2.set('worker2');
        wl3.set(new TestObject('worker2obj', 88));

        arktest.assertEQ(wl1.get(), 200);
        arktest.assertEQ(wl2.get(), 'worker2');
        arktest.assertEQ(wl3.get().a2, 88);
    });

    arktest.assertEQ(wl1.get(), 100);
    arktest.assertEQ(wl2.get(), 'modified');
    arktest.assertEQ(wl3.get().a2, 99);
}

function testNestedOperations() {
    let wl = new WorkerLocal<int>(() => 0);

    for(let i = 0; i < 10; i++) {
        let val1 = wl.get();
        let val2 = wl.get();
        arktest.assertEQ(val1, val2);
        wl.set(val1 + 1);
    }
    arktest.assertEQ(wl.get(), 10);

    let outerValue = wl.get();
    wl.set(outerValue + 100);
    let innerValue = wl.get();
    arktest.assertEQ(innerValue, outerValue + 100);
}

function main() {
    const testSuite = new arktest.ArkTestsuite("WorkerLocalTest");
    testSuite.addTest('testInit', testInit);
    testSuite.addAsyncTest('testWithoutInit', testWithoutInit);
    testSuite.addTest('testWithMultiInit', testWithMultiInit);
    testSuite.addTest('testWithworkerInit', testWithworkerInit);
    testSuite.addAsyncTest('testConcurrentReads', testConcurrentReads);
    testSuite.addAsyncTest('testConcurrentWrites', testConcurrentWrites);
    testSuite.addAsyncTest('testMultipleInstances', testMultipleInstances);
    testSuite.addTest('testNestedOperations', testNestedOperations);
    testSuite.run();
    CoroutineExtras.stopTaskpool();
}
