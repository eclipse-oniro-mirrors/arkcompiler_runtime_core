# AGENTS
**name**:interop
**path**:/arkcompiler/runtime_core/static_core/plugins/ets/runtime/interop_js
**Purpose**:This is the **interop_js** component of the ArkCompiler runtime, enabling interoperability between ETS (Extended TypeScript/ArkTS) and JavaScript environments. It sits within the larger ArkCompiler runtime at `runtime_core/static_core/plugins/ets/runtime/`.
**Primary Language**:C++

## Overview

The component allows:
- **Dynamic calls from JavaScript to ETS** (statically typed ArkTS-Sta)
- **Dynamic calls from ETS to JavaScript** (ArkTS-Dyn)
- Seamless data conversion and reference management between the two runtime systems
- Integration with Node.js NAPI (Node-API) for JavaScript execution

## Directory Structure

```
interop_js/
├── arch/          # Architecture-specific call bridges (ARM32, ARM64, AMD64)
├── call/          # Call implementations (JS->ETS, ETS->JS)
├── docs/          # API documentation (ESValue, STValue, interop guides)
├── ets_proxy/     # ETS-side proxy implementations (class/method/field wrappers)
├── intrinsics/    # Low-level intrinsic implementations
├── js_proxy/      # JavaScript-side proxy implementations
├── napi_impl/     # NAPI implementation details
├── native_api/    # Native API implementations
├── st_value/      # Static value (STValue) management
├── timer_helper/  # Timer and event loop helpers
├── xgc/           # Custom garbage collection
└── *.cpp/h        # Core implementation files
```

## Build System

To perform a full clean build(compilation + packaging), run the following command:

```bash
# precompile in the root directory
python ark.py x64.debug hybrid hybrid_tests

# create a build directory for CMake compilation
mkdir arkcompiler/runtime_core/static_core/build

arkcompiler/runtime_core/static_core/tools/ark_js_napi_cli/standalone_cp_libs_for_interop_tests.sh debug

cd arkcompiler/runtime_core/static_core/tools
ln -s ../../../ets_frontend/ets2panda es2panda

cd arkcompiler/runtime_core/static_core/build
cmake .. -GNinja -DPANDA_ETS_INTEROP_JS=1 -DCMAKE_BUILD_TYPE=Debug -DPANDA_JS_ETS_HYBRID_MODE=1
```
This component uses a dual build system integrated with the broader ArkCompiler build:

- **CMakeLists.txt**: Primary build configuration for the main runtime
- **BUILD.gn**: GN build configuration for standalone builds

**CMake Build Targets** (current build system):
- `libarkruntime.so` - Main runtime library **containing interop_js core implementation** (call bridges, proxies, JSValue, STValue, xgc, etc.)
- `ets_interop_js_napi.so` - NAPI plugin entry point (`ets_vm_plugin.cpp`), depends on libarkruntime.so

**GN Build Targets** (OHOS/OpenHarmony builds):
- `ets_interop_js_napi_static` - Static library for OHOS builds
- `ets_interop_js_napi` - Shared library for module installation

**Build Output Locations**:
- `libarkruntime.so` → `/home/cc/strongbasis/arkcompiler/runtime_core/static_core/build/lib/libarkruntime.so` 
- `ets_interop_js_napi.so` → `/home/cc/strongbasis/arkcompiler/runtime_core/static_core/build/lib/module/ets_interop_js_napi.so` 

## Test suite

To execute the code test:

```bash
# run the newly developed test cases
ninja -v ets_interop_js__setter_js_to_ets_gtests

# run all test cases
ninja -v ets_interop_js_gtests
```

The last line successfully generated by compilation is the output file of the execution result. You can check this file. If it contains content similar to the following example, then confirm that the test cases we wrote were executed correctly.

```
[==========] Running 1 test from 1 test suite.
[----------] Global test environment set-up.
[----------] 1 test from EtsSetterJsToEtsTest
[ RUN      ] EtsSetterJsToEtsTest.check_class_obj_setter
[       OK ] EtsSetterJsToEtsTest.check_class_obj_setter (13 ms)
[----------] 1 test from EtsSetterJsToEtsTest (13 ms total)

[----------] Global test environment tear-down
[==========] 1 test from 1 test suite ran. (13 ms total)
[  PASSED  ] 1 test.
```

## Architecture

### Core Concepts

**InteropCtx**: Central context managing the interoperability state, reference tracking, and garbage collection between JS and ETS runtimes.

**Two Interoperability APIs**:

1. **ESValue**: Wrapper class for ArkTS-Sta to operate on dynamically typed ArkTS-Dyn objects. Provides dynamic operations like `getProperty`, `setProperty`, `invoke`, `instantiate`, etc.

2. **STValue**: Wrapper class for ArkTS-Dyn to access statically-typed ArkTS-Sta modules. Provides type-safe operations with explicit `SType` enumeration (BOOLEAN, INT, LONG, FLOAT, DOUBLE, REFERENCE, VOID, etc.).

**Function Signature Mangling**: STValue uses name mangling for overloaded functions with format `parameter_type:return_type` (e.g., `'zz:z'` for `(boolean, boolean): boolean`).

### Key Components

**Proxy Systems** (`ets_proxy/`, `js_proxy/`):
- Wraps ETS classes/methods/fields for JavaScript access
- Wraps JavaScript objects for ETS access
- `shared_reference.h/cpp`: Manages shared references between runtimes

**Call Bridge** (`call/`, `arch/`):
- `call_js.cpp`: ETS → JavaScript calls
- `call_ets.cpp`: JavaScript → ETS calls
- Architecture-specific implementations: ARM32, ARM64, AMD64

**Value Conversion**:
- `JSValue`: Core class representing JavaScript values in ETS runtime
- `js_refconvert.h/cpp`: Handles conversion between JS and ETS reference types
- `JSValueStringStorage`: Optimized string storage for interop operations

**Memory Management** (`xgc/`):
- Custom garbage collection for cross-runtime references
- `SharedReferenceStorage`: Tracks shared references between JS and ETS
- `SharedReferenceStorageVerifier`: Verification system for reference integrity

**Intrinsics API** (`intrinsics/`, `intrinsics_api_impl.h/cpp`):
- Low-level intrinsic functions for interop
- Direct access to JS runtime from ETS code

**Event Loop Integration**:
- `event_loop_module.h/cpp`: Event loop integration
- `timer_module.h/cpp`: Timer functionality
- `js_job_queue.h/cpp`: Job queue for async operations

## Important Patterns

**Reference Management**: Extensive use of shared references with lifecycle tracking. Always consider cross-runtime GC implications.

**Error Handling**:
- `NAPI_CHECK_FATAL` macro for NAPI error checking
- `Expected` pattern for error propagation
- `ASSERT_SCOPED_NATIVE_CODE()` for thread safety

**Type Conversion**: Systematic conversion between JS and ETS types through the JSValue and ESValue/STValue wrapper systems.

**Configuration**: `runtime_options.yaml` provides configurable options for XGC settings, task pool support, and verifier settings.

## Documentation

Key documentation files in `docs/`:
- `ESValueApi_en.md`: Complete ESValue API reference
- `stvalue_en.md`: Complete STValue API reference
- `interop.md`: Interop declaration files and glue code guidelines
