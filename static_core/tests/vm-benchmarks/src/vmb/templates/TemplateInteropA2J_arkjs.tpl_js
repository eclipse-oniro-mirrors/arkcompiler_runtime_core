/*
 * Copyright (c) 2025 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the 'License');
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an 'AS IS' BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

const DEFAULT_ITERATIONS = 100000;
const helper = requireNapiPreview('libinterop_test_helper.so', false);

function print_log(msg) {
    print(msg); // NOTE can be console.log or print or something else depending on platform
}

class Benchmark {
    #ark = requireNapiPreview('ets_interop_js_napi.so', false);
    #benchmark;
    #passedTime = BigInt(0);
    #binaries = [];
    constructor(...binaries) {
        this.#binaries = binaries;
        this.#__init();
    }

    #__init() {
        if (helper === undefined) {
            throw new Error('Failed to initialize helper');
        }

    	let stdlibPath = helper.getEnvironmentVar('ARK_ETS_STDLIB_PATH');

        let etsVm = requireNapiPreview('ets_interop_js_napi.so', false);
        if (this.#ark === undefined) {
            throw new Error('Failed to initialize etsVm');
        }

        const etsVmOpts = helper.getEnvironmentVar('ETS_VM_OPTS');
        let etsVmRes = this.#ark.createRuntime(Object.assign({
                'boot-panda-files': [stdlibPath, ...this.#binaries].join(':'),
                'panda-files': this.#binaries.join(':')
        }, JSON.parse(etsVmOpts)));

        if (!etsVmRes) {
            throw new Error('Failed to initialize');
        }
    }

    #prepare() {
        const TestClass = this.#ark.getClass("L$STATE" + "_" + "$METHOD" + "/$STATE;");
        this.#benchmark = new TestClass();
        this.#benchmark.setup();
    }

    #loopFromJS(iterations = DEFAULT_ITERATIONS) {
        if (!Number.isFinite(iterations)) {
            throw new Error(`Iteration count should be a valid integer, $${iterations} given instead`);
        }
        for (let i = 0; i < iterations ?? this.iterations; i++) {
            const startTimeMSec = BigInt(Date.now());
            this.#benchmark.$METHOD();
            const endTimeMSec = BigInt(Date.now());
            const MILLIS2NANOS = 1000000;
            this.#passedTime += (endTimeMSec - startTimeMSec) * BigInt(MILLIS2NANOS);
        }
        return this.#passedTime;
    }

    #loopFromArk(iterations = DEFAULT_ITERATIONS) {
        if (!Number.isFinite(iterations)) {
            throw new Error(`Iteration count should be a valid integer, $${iterations} given instead`);
        }
        this.#benchmark.runsLeft = iterations;
        return Number(this.#benchmark.$METHOD());
    }

    run(iterations = DEFAULT_ITERATIONS) {
        this.#prepare();
        const isSelfTimed = this.#benchmark.totalTime !== undefined;
        const testRunner = isSelfTimed ? this.#loopFromArk.bind(this) : this.#loopFromJS.bind(this);
        const timing = testRunner(iterations);
        print("Benchmark result: $NAME " + timing);
    }
}

let interopJsGtestAbcPath = helper.getEnvironmentVar('ARK_ETS_INTEROP_JS_GTEST_ABC_PATH');
const benchmark = new Benchmark(interopJsGtestAbcPath);

let vmbBenchUnitIterations = helper.getEnvironmentVar('VMB_BENCH_UNIT_ITERATIONS');
const iterations = (vmbBenchUnitIterations && Number.isFinite(Number(vmbBenchUnitIterations)))
    ? Number(vmbBenchUnitIterations)
    : DEFAULT_ITERATIONS;

benchmark.run(iterations);