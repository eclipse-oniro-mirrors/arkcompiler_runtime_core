# libabckit (AbcKit) — Agent Guide

This document is the **full working guide** for **`arkcompiler/runtime_core/libabckit`**.

Source-of-truth docs already in repo: **doc/implementation_description.md**, **doc/mini_cookbook.md**, **doc/how_to_build_and_test.md** (and `_zh` variants).

---

## What is libabckit?

**libabckit** is a library to **inspect and modify Ark bytecode** (`.abc`).

It supports:

- **Dynamic ABC**: bytecode produced from **JS** and **ArkTS** (handled via the **dynamic** runtime).
- **Static ABC**: bytecode produced from **static ArkTS** (handled via the **static** runtime).

The public API is provided in:

- **C API**: **include/libabckit/c/** (abckit.h, metadata_core.h, ir_core.h, isa/isa_dynamic.h, isa/isa_static.h, extensions/js/, extensions/arkts/)
- **C++ API wrappers**: **include/libabckit/cpp/** (higher-level OO wrappers around the C API)

---

## High-level pipeline / internal representations

Transformations flow through these representations:

1. `.abc` file is opened into **panda_file** (dynamic: **panda::**, static: **ark::**).
2. **abc2program** converts **panda_file** → **pandasm** (program-level representation).
3. **Metadata APIs** inspect/modify **pandasm** (modules, namespaces, classes, functions, annotations, literals, …).
4. When graph-level work is required: convert function back to **panda_file** (IR builder consumes panda_file), then IR builder creates **ark::compiler::Graph**.
5. **Graph APIs / ISA APIs** inspect/modify **Graph** (basic blocks, instructions).
6. Codegen converts **Graph** → bytecode (**pandasm** function body) and replaces the original.
7. **writeAbc** writes **pandasm** back to `.abc`.

Key takeaway:

- **Metadata layer** ≈ **pandasm**
- **Graph layer** ≈ **ark::compiler::Graph** (single internal IR used for both dynamic and static)

---

## Repository layout (where things live)

### Public headers

- **C API** entry and versioning: **include/libabckit/c/abckit.h**, **api_version.h**, **statuses.h**
- **Core metadata**: **include/libabckit/c/metadata_core.h**
- **Graph / IR**: **include/libabckit/c/ir_core.h**
- **ISA** (flavor-specific): **include/libabckit/c/isa/isa_dynamic.h**, **isa/isa_static.h**
- **Language extensions**: **include/libabckit/c/extensions/js/metadata_js.h**, **extensions/arkts/metadata_arkts.h**

### Core implementation (dispatch + common logic)

Located in **src/**:

- **abckit_impl.cpp** — top-level API glue
- **metadata_inspect_impl.cpp**, **metadata_modify_impl.cpp**
- **metadata_js_*_impl.cpp**, **metadata_arkts_*_impl.cpp**, **metadata_unknown_*_impl.cpp**
- **ir_impl.cpp**, **ir_interface_impl.cpp**
- **isa_dynamic_impl.cpp**, **isa_static_impl.cpp**, **isa_dynamic_impl_instr_*.cpp**

These files validate arguments, set last-error, perform **target dispatch** (dynamic vs static), and build/own **opaque Abckit\*** structs.

### Runtime-specific implementations (do not mix includes)

- **src/adapter_dynamic/** — **dynamic** runtime only
- **src/adapter_static/** — **static** runtime only

**Rule:** Do not include both runtimes' headers in the same `.cpp`; the repo enforces separation (header name collisions and include-path setup).

### Wrappers (bridging dynamic and static safely)

- **src/wrappers/** — used when a feature needs both runtimes but must avoid including both header sets in one TU.

---

## Error handling conventions (C API)

Most C API functions set a global “last error” status and return either a value/pointer or a boolean for success.

Patterns: **LIBABCKIT_CLEAR_LAST_ERROR**, **LIBABCKIT_BAD_ARGUMENT(x, ret)**, **impl->getLastError()** for callers. When adding or changing APIs, keep these conventions.

---

## Build and test (common commands)

### Build packages (Linux example)

```bash
./ark.py x64.release abckit_packages --gn-args="is_standard_system=true abckit_enable=true enable_cmc_gc=false"
```

### Run tests

```bash
./ark.py x64.release abckit_tests --gn-args="is_standard_system=true abckit_enable=true abckit_enable_tests=true enable_cmc_gc=false"
```

### Full self-check (format + tidy + tests)

```bash
./arkcompiler/runtime_core/libabckit/scripts/self-check.sh --dir=/path/to/standalone/root
```

### Generated test helpers

Some negative tests (nullptr / wrong ctx / mode / imm) are generated by scripts:

```bash
cd arkcompiler/runtime_core/libabckit
./scripts/manage_gen_tests.sh gen
```

---

## How to add a new feature (practical checklist)

### A) Metadata API (inspect/modify pandasm)

Use when the feature reads/writes: modules, namespaces, classes, functions, annotations, literals/values/types, names/visibility/attributes.

1. **Add to public headers** — usually **include/libabckit/c/metadata_core.h**, or **extensions/js/metadata_js.h** / **extensions/arkts/metadata_arkts.h**.
2. **Add dispatch implementation** — add **extern "C"** function in **src/metadata_*_impl.cpp**; do argument validation and dispatch by target (**IsDynamic(module->target)** or equivalent).
3. **Implement dynamic and/or static backend** — **src/adapter_dynamic/** and/or **src/adapter_static/**.
4. **Register in API table** — wire the function in the pointer table used by **AbckitGet*ApiImpl**; otherwise it is not reachable.
5. **Add tests** — **tests/ut/**; consider generated negative tests (nullptr, wrong ctx/mode) if applicable.

### B) Graph / IR / ISA feature (inspect/modify ark::compiler::Graph)

Use when the feature reads/writes: basic blocks, instructions (create/replace/rewire), ISA-specific helpers (dynamic vs static).

1. **Add to public headers** — **include/libabckit/c/ir_core.h** for graph APIs; **isa/isa_dynamic.h** or **isa/isa_static.h** for ISA helpers.
2. **Implement** in **src/ir_impl.cpp** or **src/isa_*_impl.cpp**.
3. If runtime-specific logic is needed, place it in the corresponding **adapter_dynamic/** or **adapter_static/** directory.
4. **Add tests** under **tests/ut/ir_core/** or **tests/ut/isa/**.

---

## Critical pitfalls / "do not do this"

- **Do not** include both dynamic and static runtime headers in one `.cpp`. Use **adapter_dynamic/**, **adapter_static/**, and **wrappers/** patterns.
- **Do not** expose internal struct layouts of `Abckit*` opaque types in public headers.
- **Do not** skip last-error updates; keep error handling consistent.
- **Remember API table wiring**: adding a function without wiring it into the API struct makes it unreachable.
- **Graph roundtrip is not identity**: **graph → bytecode → graph** can differ due to cleanup/optimization passes.

---

## Where to look for examples

- End-to-end usage: **doc/mini_cookbook.md** (and **mini_cookbook_zh.md**)
- Implementation architecture: **doc/implementation_description.md** (and **implementation_description_zh.md**)
- Tests: **tests/ut/** (unit), **tests/clean_scenarios/**, **tests/scenarios/** (scenario/integration), **tests/null_args_tests/**, **tests/wrong_ctx_tests/** (generated negative)

---

## Plugin usage (context)

AbcKit can be used via the **abckit** executable by loading a plugin shared library. See **doc/how_to_build_and_test.md** (and `_zh`) for the **Entry(AbckitFile *file)** plugin entrypoint example.
